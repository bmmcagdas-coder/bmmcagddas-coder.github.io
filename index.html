<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Duyuru KaydÄ± - Staj Takip Sistemi</title>
    <!-- OneSignal v16 SDK -->
    <script src="https://cdn.onesignal.com/sdks/web/v16/OneSignalSDK.page.js" defer></script>
    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const uid = urlParams.get('uid');
        const appId = urlParams.get('appid');
        const role = urlParams.get('role') || "Bilinmiyor";

        // Hata KontrolÃ¼
        if (!uid || !appId) {
            window.onload = function() {
                showErrorMessage("GeÃ§ersiz kayÄ±t linki! Parametreler eksik.");
            };
        }

        window.OneSignalDeferred = window.OneSignalDeferred || [];
        OneSignalDeferred.push(async function(OneSignal) {
            try {
                // === ONESIGNAL BAÅLATMA (TÃœM AYARLARINIZ KORUNDU) ===
                await OneSignal.init({
                    appId: appId,
                    allowLocalhostAsSecureOrigin: true,
                    serviceWorkerParam: { scope: '/' },
                    serviceWorkerPath: 'OneSignalSDKWorker.js',
                    promptOptions: {
                        slidedown: {
                            enabled: true,
                            autoPrompt: true,
                            timeDelay: 0,
                            pageViews: 1,
                            text: {
                                actionMessage: "Staj duyurularÄ± ve maaÅŸ bildirimlerini anlÄ±k almak ister misiniz?",
                                acceptButton: "Evet, Ä°zin Ver",
                                cancelButton: "HayÄ±r, TeÅŸekkÃ¼rler"
                            }
                        }
                    },
                    notifyButton: {
                        enabled: false 
                    }
                });

                // KullanÄ±cÄ± GiriÅŸi ve Etiketleme
                await OneSignal.login(uid);
                await OneSignal.User.addTag("role", role);

                // === KRÄ°TÄ°K GÃœNCELLEME: GERÃ‡EK ABONELÄ°K TAKÄ°BÄ° ===
                // Sadece izin verildiÄŸine deÄŸil, OneSignal'Ä±n cihazÄ± tescil ettiÄŸine (ID oluÅŸturduÄŸuna) bakÄ±yoruz.
                OneSignal.User.PushSubscription.addEventListener("change", (event) => {
                    console.log("Abonelik durumu deÄŸiÅŸti:", event.current);
                    if (event.current.id && event.current.token) {
                        showSuccessMessage(event.current.id);
                    }
                });

                // EÄŸer cihaz zaten aboneyse bekletmeden baÅŸarÄ± gÃ¶ster
                if (OneSignal.User.PushSubscription.id) {
                    showSuccessMessage(OneSignal.User.PushSubscription.id);
                }

                // === EVENT LISTENERS (ORÄ°JÄ°NAL MANTIK) ===
                OneSignal.Slidedown.addEventListener("slidedownAccept", async () => {
                    console.log("KullanÄ±cÄ± kabul etti, tarayÄ±cÄ± izni isteniyor...");
                    await OneSignal.Notifications.requestPermission();
                });

                // Ä°zin durumunu da dinlemeye devam edelim (v16 yedek kontrol)
                OneSignal.Notifications.addEventListener("permissionChange", (permission) => {
                    if (permission === true || permission === "granted") {
                        // Ä°zin verildi ama tescil (PushSubscription) iÃ§in birkaÃ§ saniye daha gerekebilir
                        console.log("Ä°zin verildi, tescil bekleniyor...");
                    }
                });

                // === ZAMANLAYICI KONTROLÃœ (4 saniye sonra kutu Ã§Ä±kmadÄ±ysa kÄ±lavuzu gÃ¶ster) ===
                setTimeout(() => {
                    // EÄŸer hem izin yoksa hem de abonelik ID'si henÃ¼z oluÅŸmadÄ±ysa kÄ±lavuzu gÃ¶ster
                    if (!OneSignal.Notifications.permission && !OneSignal.User.PushSubscription.id) {
                        showPartialSuccessMessage();
                    }
                }, 4000);

            } catch (e) {
                console.error("OneSignal HatasÄ±:", e);
                showErrorMessage(e.message);
            }
        });

        // === GÃ–RSEL FONKSÄ°YONLAR (ORÄ°JÄ°NAL TASARIM VE METÄ°NLER KORUNDU) ===

        function showSuccessMessage(registrationId) {
            document.body.innerHTML = `
                <div style="text-align:center; margin-top:100px; color:#2ecc71; font-family:Arial, sans-serif; padding:20px;">
                    <div style="font-size:60px;">âœ…</div>
                    <h2>Tescil BaÅŸarÄ±yla TamamlandÄ±!</h2>
                    <p style="color:#333; font-size:1.2em;">DuyurularÄ± ve maaÅŸ bildirimlerini artÄ±k anlÄ±k alacaksÄ±nÄ±z.</p>
                    <div style="background:#eafaf1; border:1px solid #2ecc71; padding:10px; border-radius:8px; display:inline-block; margin:15px 0; font-size:11px; color:#27ae60;">
                        KayÄ±t No: ${registrationId}
                    </div>
                    <p>Bu pencereyi gÃ¼venle kapatÄ±p uygulamaya dÃ¶nebilirsiniz.</p>
                    <button onclick="window.close()" style="margin-top:20px; padding:12px 25px; background:#2ecc71; color:white; border:none; border-radius:8px; cursor:pointer; font-weight:bold;">PENCEREYÄ° KAPAT</button>
                </div>`;
        }

        function showPartialSuccessMessage() {
            document.body.innerHTML = `
                <div style="text-align:center; margin-top:50px; color:#e67e22; font-family:Arial, sans-serif; padding:20px;">
                    <div style="font-size:60px;">â³</div>
                    <h2>Ä°zin Kutusu Bekleniyor...</h2>
                    <p style="font-size:1.1em; color:#333;"><strong>LÃ¼tfen tarayÄ±cÄ±dan Ã§Ä±kan tam ekran izin kutusuna "Ä°zin Ver" basÄ±n!</strong></p>
                    
                    <div style="background:#fff5f5; border:1px solid #e67e22; padding:20px; border-radius:12px; display:inline-block; text-align:left; margin:20px 0; max-width:400px;">
                        <b style="color:#d35400;">Kutu Ã§Ä±kmadÄ±ysa veya kapandÄ±ysa:</b>
                        <ol style="margin-top:10px;">
                            <li>Adres Ã§ubuÄŸundaki <b>Kilit/Ayar</b> simgesine basÄ±n.</li>
                            <li><b>Bildirimler</b> seÃ§eneÄŸini bulup <b>"Ä°zin Ver"</b> yapÄ±n.</li>
                        </ol>
                    </div>
                    
                    <p style="color:red; font-weight:bold; font-size:1.2em;">Pencereyi kapatmayÄ±n â€“ Ä°ÅŸlemi tamamlayÄ±n!</p>
                    <button onclick="location.reload()" style="padding:10px 20px; background:#3498db; color:white; border:none; border-radius:8px; cursor:pointer; font-weight:bold;">KUTUYU TEKRAR AÃ‡MAYI DENE</button>
                </div>`;
        }

        function showErrorMessage(msg) {
            document.body.innerHTML = `
                <div style="text-align:center; margin-top:100px; color:red; font-family:Arial, sans-serif; padding:20px;">
                    <div style="font-size:60px;">âŒ</div>
                    <h2>Hata OluÅŸtu</h2>
                    <p style="color:#333;">${msg}</p>
                    <button onclick="location.reload()" style="margin-top:20px; padding:10px 20px; background:#e74c3c; color:white; border:none; border-radius:8px; cursor:pointer;">TEKRAR DENE</button>
                </div>`;
        }
    </script>
</head>
<body style="font-family:Arial, sans-serif; text-align:center; padding:50px; background:#f0f8ff;">
    <div id="loading-card" style="background:white; padding:40px; border-radius:20px; box-shadow:0 10px 30px rgba(0,0,0,0.1); display:inline-block; width:100%; max-width:500px; margin:0 auto; box-sizing:border-box;">
        <h2 style="color:#2ecc71;">ğŸ”” Bildirim KaydÄ± YapÄ±lÄ±yor...</h2>
        <p style="font-size:1.2em; margin:30px 0; color:#444;">LÃ¼tfen karÅŸÄ±nÄ±za Ã§Ä±kacak olan <b>"Evet, Ä°zin Ver"</b> butonuna basÄ±n.</p>
        <p style="background:#fff9db; padding:10px; border-radius:8px;"><small>Android/iPhone'da izin kutusu gecikebilir. LÃ¼tfen bu pencereyi kapatmadan bekleyin.</small></p>
    </div>
</body>
</html>
