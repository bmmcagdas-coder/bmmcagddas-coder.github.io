<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Duyuru KaydÄ±</title>
    <!-- OneSignal v16 SDK -->
    <script src="https://cdn.onesignal.com/sdks/web/v16/OneSignalSDK.page.js" defer></script>
    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const uid = urlParams.get('uid');
        const appId = urlParams.get('appid');
        const role = urlParams.get('role') || "Bilinmiyor";

        if (!uid || !appId) {
            document.body.innerHTML = '<h2 style="color:red; text-align:center; margin-top:100px;">GeÃ§ersiz kayÄ±t linki!</h2>';
            throw new Error("GeÃ§ersiz parametreler");
        }

        window.OneSignalDeferred = window.OneSignalDeferred || [];
        OneSignalDeferred.push(async function(OneSignal) {
            try {
                await OneSignal.init({
                    appId: appId,
                    allowLocalhostAsSecureOrigin: true,
                    serviceWorkerParam: { scope: '/' },
                    serviceWorkerPath: 'OneSignalSDKWorker.js',
                    promptOptions: {
                        slidedown: {
                            enabled: true,
                            autoPrompt: true,
                            timeDelay: 0,
                            pageViews: 1,
                            text: {
                                actionMessage: "Staj duyurularÄ± ve maaÅŸ bildirimlerini anlÄ±k almak ister misiniz?",
                                acceptButton: "Evet, Ä°zin Ver",
                                cancelButton: "HayÄ±r, TeÅŸekkÃ¼rler"
                            }
                        }
                    },
                    notifyButton: {
                        enabled: false  // Abonelikten Ã§Ä±k butonu kapalÄ±
                    }
                });

                // KullanÄ±cÄ±yÄ± login et
                await OneSignal.login(uid);

                // Rol tag'i ekle
                await OneSignal.User.addTag("role", role);

                // === YENÄ°: Slidedown kabul edildiÄŸinde native prompt'u zorla tetikle ===
                OneSignal.Slidedown.addEventListener("slidedownShown", () => {
                    // Slidedown gÃ¶sterildiÄŸinde kullanÄ±cÄ±yÄ± bilgilendir
                    console.log("Slidedown gÃ¶sterildi");
                });

                OneSignal.Slidedown.addEventListener("slidedownAccept", async () => {
                    console.log("KullanÄ±cÄ± 'Evet, Ä°zin Ver' dedi â€“ native prompt tetikleniyor");
                    // Native izin kutusunu manuel olarak iste (Android'da daha stabil)
                    await OneSignal.Notifications.requestPermission();
                });

                // === Native izin deÄŸiÅŸimini dinle ===
                OneSignal.Notifications.addEventListener("permissionChange", (granted) => {
                    if (granted) {
                        showSuccessMessage();
                    }
                });

                // === 4 saniye sonra hala izin yoksa uyarÄ± gÃ¶ster ===
                setTimeout(() => {
                    if (!OneSignal.Notifications.permission) {
                        showPartialSuccessMessage();
                    }
                }, 4000);

            } catch (e) {
                console.error("OneSignal hatasÄ±:", e);
                showErrorMessage(e.message);
            }
        });

        function showSuccessMessage() {
            document.body.innerHTML = `
                <div style="text-align:center; margin-top:100px; color:#2ecc71; font-family:Arial, sans-serif;">
                    <h2>âœ… KayÄ±t BaÅŸarÄ±yla TamamlandÄ±!</h2>
                    <p>DuyurularÄ± ve maaÅŸ bildirimlerini alacaksÄ±nÄ±z.</p>
                    <p><strong>TarayÄ±cÄ± izin kutusuna da "Ä°zin Ver" bastÄ±ÄŸÄ±nÄ±zdan emin olun.</strong></p>
                    <p>Bu pencereyi gÃ¼venle kapatabilirsiniz.</p>
                </div>`;
        }

        function showPartialSuccessMessage() {
            document.body.innerHTML = `
                <div style="text-align:center; margin-top:100px; color:#e67e22; font-family:Arial, sans-serif;">
                    <h2>â³ Ä°zin Kutusu Bekleniyor...</h2>
                    <p style="font-size:1.1em;"><strong>LÃ¼tfen tarayÄ±cÄ±dan Ã§Ä±kan tam ekran izin kutusuna "Ä°zin Ver" basÄ±n!</strong></p>
                    <p>Kutu Ã§Ä±kmadÄ±ysa veya kapandÄ±ysa:</p>
                    <ol style="text-align:left; display:inline-block; margin:20px 0;">
                        <li>Chrome > Ayarlar > Site ayarlarÄ± > Bildirimler</li>
                        <li>Siteyi bulup <strong>"Ä°zin Ver"</strong> seÃ§in.</li>
                    </ol>
                    <p style="color:red; font-weight:bold;">Pencereyi kapatmayÄ±n â€“ 20 saniye bekleyin!</p>
                </div>`;
            setTimeout(() => { window.close(); }, 20000);
        }

        function showErrorMessage(msg) {
            document.body.innerHTML = `
                <div style="text-align:center; margin-top:100px; color:red; font-family:Arial, sans-serif;">
                    <h2>âŒ Hata OluÅŸtu</h2>
                    <p>${msg}</p>
                    <p>LÃ¼tfen sayfayÄ± yenileyip tekrar deneyin.</p>
                </div>`;
        }
    </script>
</head>
<body style="font-family:Arial, sans-serif; text-align:center; padding:50px; background:#f0f8ff;">
    <div style="background:white; padding:40px; border-radius:20px; box-shadow:0 10px 30px rgba(0,0,0,0.1); max-width:500px; margin:0 auto;">
        <h2 style="color:#2ecc71;">ğŸ”” Bildirim KaydÄ± YapÄ±lÄ±yor...</h2>
        <p style="font-size:1.2em; margin:30px 0;">LÃ¼tfen Ã§Ä±kan <b>"Evet, Ä°zin Ver"</b> butonuna basÄ±n.</p>
        <p><small>Android'de izin kutusu gecikebilir. Ã‡Ä±kmazsa Chrome ayarlarÄ±ndan manuel izin verin.</small></p>
    </div>
</body>
</html>
